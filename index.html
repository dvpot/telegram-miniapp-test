<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Telegram Mini App ‚Äî English Words</title>

  <link rel="stylesheet" href="styles.css">

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

</head>
<body>
  <div class="app">
    <div class="card">

      <div class="content">

        <div class="header">
          <div id="username" class="username">–ü—Ä–∏–≤–µ—Ç!</div>
        </div>

        <div id="imageArea" class="image-area" aria-live="polite">
          <div id="imagePlaceholder" class="image-placeholder">–ö–∞—Ä—Ç–∏–Ω–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</div>
        </div>

        <div class="center">

          <div id="wordField" class="field" role="button" tabindex="0">
            <div class="field-row">
              <div class="word-col">
                <p id="wordText" class="word-text">---</p>
                <p id="transText" class="trans-text">---</p>
              </div>

              <button id="speakEN_small" class="tts-btn small">üîä</button>
            </div>
          </div>

          <div class="translation-field">
            <p id="translationText" class="translation-text">---</p>
            <button id="speakRU_small" class="tts-btn small">üîä</button>
          </div>

        </div>
      </div>

      <button id="nextBtn" class="btn">–°–ª–µ–¥—É—é—â–µ–µ —Å–ª–æ–≤–æ</button>
    </div>
  </div>


  <!-- ========================================================= -->
  <!--                –í–°–¢–†–û–ï–ù–ù–´–ô JS –ö–û–¢–û–†–´–ô –†–ê–ë–û–¢–ê–ï–¢            -->
  <!-- ========================================================= -->

  <script>
    // Telegram
    const tg = window.Telegram?.WebApp;
    if (tg) tg.ready();

    // DOM
    const usernameEl = document.getElementById('username');
    const imageArea = document.getElementById('imageArea');
    const wordField = document.getElementById('wordField');
    const wordText = document.getElementById('wordText');
    const transText = document.getElementById('transText');
    const translationText = document.getElementById('translationText');
    const speakENBtn = document.getElementById('speakEN_small');
    const speakRUBtn = document.getElementById('speakRU_small');
    const nextBtn = document.getElementById('nextBtn');

    // Telegram –∏–º—è
    const user = tg?.initDataUnsafe?.user;
    if (user) {
      usernameEl.textContent = `–ü—Ä–∏–≤–µ—Ç, ${user.first_name || user.username}!`;
    }

    // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ ---
    let words = [];
    let current = null;
    let revealed = false;

    // --- –¶–≤–µ—Ç–∞ ---
    function colorForWord(word) {
      if (!word) return null;
      const map = {
        red:"red", blue:"blue", green:"green", yellow:"yellow",
        pink:"pink", purple:"purple", black:"black", white:"white",
        brown:"brown", grey:"grey", gray:"gray", orange:"orange",
        gold:"gold", silver:"silver", "sky blue":"skyblue", skyblue:"skyblue"
      };
      return map[word.toLowerCase()] || null;
    }

    // --- –ö–∞—Ä—Ç–∏–Ω–∫–∞ ---
    function showTextInstead(text) {
      imageArea.innerHTML = "";
      imageArea.style.background = "#f3f4f6";
      const d = document.createElement("div");
      d.className = "image-placeholder";
      d.textContent = text?.toUpperCase() || "‚Äî";
      imageArea.appendChild(d);
    }

    function setImageContent(src, translation, word) {
      imageArea.innerHTML = "";
      imageArea.style.background = "";

      const color = colorForWord(word);
      if (color) {
        imageArea.style.background = color;
        const d = document.createElement("div");
        d.className = "image-placeholder";
        d.textContent = "";
        imageArea.appendChild(d);
        return;
      }

      if (src) {
        const img = document.createElement("img");
        img.src = src;
        img.alt = word || translation || "image";
        img.onerror = () => showTextInstead(translation);
        imageArea.appendChild(img);
        return;
      }

      showTextInstead(translation);
    }


    // --- –ó–∞–≥—Ä—É–∑–∫–∞ words.json (–Ω–∞–¥—ë–∂–Ω–∞—è) ---
    function loadWords() {
      return fetch("words.json?nocache=" + Date.now())
        .then(r => r.json())
        .then(j => { words = j; })
        .catch(e => {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ words.json:", e);
          words = [];
        });
    }


    // --- –ù–æ–≤–æ–µ —Å–ª–æ–≤–æ ---
    function loadRandomWord() {
      if (!words.length) {
        wordText.textContent = "---";
        transText.textContent = "---";
        translationText.textContent = "---";
        setImageContent(null, null, null);
        return;
      }

      current = words[Math.floor(Math.random() * words.length)];
      revealed = false;

      wordText.textContent = current.word || "---";
      transText.textContent = current.transcription ? `[${current.transcription}]` : "---";
      translationText.textContent = current.translation || "---";

      setImageContent(
        current.image || null,
        current.translation || "",
        current.word || ""
      );

      wordText.classList.remove("visible");
      transText.classList.remove("visible");
      speakENBtn.classList.remove("visible");
    }

    // --- –†–∞—Å–∫—Ä—ã—Ç–∏–µ —Å–ª–æ–≤–∞ ---
    function reveal() {
      if (!revealed) {
        revealed = true;
        wordText.classList.add("visible");
        transText.classList.add("visible");
        speakENBtn.classList.add("visible");
      }
    }

    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ---
    wordField.addEventListener("click", reveal);
    nextBtn.addEventListener("click", loadRandomWord);

    // –ö–Ω–æ–ø–∫–∏ –∑–≤—É–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é
    speakENBtn.style.display = "none";
    speakRUBtn.style.display = "none";

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    loadWords().then(loadRandomWord);

  </script>

</body>
</html>
