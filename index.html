<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Telegram Mini App ‚Äî English Words</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#eef2f5;
      --card:#ffffff;
      --accent:#0088cc;
      --accent-dark:#006fa6;
      --muted:#6b7280;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial;
      background:var(--bg);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .app{
      max-width:600px;
      margin:0 auto;
      height:100vh;
      padding:12px;
      display:flex;
      align-items:stretch;
    }

    .card{
      flex:1;
      background:var(--card);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:0 8px 22px rgba(0,0,0,0.08);
      display:flex;
      flex-direction:column;
      justify-content:space-between;   /* <<< –¥–æ–±–∞–≤–ª–µ–Ω–æ */
      gap:16px;
    }

    .header{ display:flex; align-items:center; justify-content:space-between; }
    .username{ font-size:20px; font-weight:700; margin:0; }

    .image-area{
      width:100%;
      min-height:160px;
      background:#e9ecef;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .image-area img{ width:100%; height:auto; object-fit:cover; display:block; }

    .image-placeholder{ color:var(--muted); font-size:14px; padding:8px 12px; text-align:center; }

    /* –æ–±—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–∏ */
    .center {
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    /* –ø–æ–ª–µ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —Å–ª–æ–≤–∞ (–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏) */
    .field {
      background:#fafafa;
      border:1px solid #d7d7d7;
      border-radius:12px;
      padding:12px;
      cursor:pointer;
      transition:background .18s ease;
    }
    .field:hover{ background:#f4f6f7; }

    /* —Å—Ç—Ä–æ–∫–∞ —Å —Ç–µ–∫—Å—Ç–æ–º –∏ –∫–Ω–æ–ø–∫–æ–π —Å–ø—Ä–∞–≤–∞ */
    .field-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .word-col{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }

    .word-text{
      font-size:24px;
      font-weight:700;
      margin:0;
      color:#111;
      opacity:0;
      transition:opacity .28s ease;
      word-break:break-word;
    }
    .trans-text{
      font-size:15px;
      color:var(--muted);
      margin:0;
      opacity:0;
      transition:opacity .28s ease;
    }
    .visible{ opacity:1 !important; }

    /* –ø–µ—Ä–µ–≤–æ–¥–Ω—ã–π –±–ª–æ–∫ —Å –∫–Ω–æ–ø–∫–æ–π —Å–ø—Ä–∞–≤–∞ */
    .translation-field{
      background:#fafafa;
      border-radius:12px;
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border:1px solid #d7d7d7;
    }
    .translation-text{
      font-size:22px;
      font-weight:700;
      margin:0;
      color:#111;
    }

    /* –∫–Ω–æ–ø–∫–∏ –æ–∑–≤—É—á–∫–∏ (–º–∞–ª—ã–µ) */
    .tts-btn {
      background:var(--accent);
      color:#fff;
      border:none;
      border-radius:50%;
      width:40px;
      height:40px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      cursor:pointer;
      transition:transform .12s ease, background .12s;
      box-shadow:0 4px 8px rgba(0,0,0,0.06);
    }
    .tts-btn:hover{ transform:translateY(-2px); background:var(--accent-dark); }
    .tts-btn.small{ width:38px; height:38px; font-size:15px; }

    /* EN button hidden until reveal */
    #speakEN_small{ opacity:0; pointer-events:none; transition:opacity .2s; }
    #speakEN_small.visible{ opacity:1; pointer-events:auto; }

    /* –∫–Ω–æ–ø–∫–∞ "–°–ª–µ–¥—É—é—â–µ–µ" */
    .btn{
      width:100%;
      padding:14px;
      border-radius:12px;
      background:var(--accent);
      color:#fff;
      font-size:18px;
      font-weight:700;
      border:none;
      cursor:pointer;
    }
    .btn:hover{ background:var(--accent-dark); }

    .content{
      display:flex;
      flex-direction:column;
      gap:16px;
      flex:1;              /* —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –≤–≤–µ—Ä—Ö */
    }
    
    /* –∞–¥–∞–ø—Ç–∏–≤ */
    @media (max-width:420px){
      .word-text{ font-size:20px; }
      .translation-text{ font-size:20px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">

      <div class="content">
      
          <div class="header">
            <div id="username" class="username">–ü—Ä–∏–≤–µ—Ç!</div>
          </div>
    
          <div id="imageArea" class="image-area">
            <div id="imagePlaceholder" class="image-placeholder">–ö–∞—Ä—Ç–∏–Ω–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</div>
          </div>
    
          <div class="center">
            <!-- –ê–Ω–≥–ª–∏–π—Å–∫–æ–µ —Å–ª–æ–≤–æ + —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è + EN button (—Å–ø—Ä–∞–≤–∞) -->
            <div id="wordField" class="field" role="button" tabindex="0" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ —Å–ª–æ–≤–æ">
              <div class="field-row">
                <div class="word-col">
                  <p id="wordText" class="word-text">---</p>
                  <p id="transText" class="trans-text">---</p>
                </div>
    
                <!-- EN small button (hidden until reveal) -->
                <button id="speakEN_small" class="tts-btn small" aria-label="–û–∑–≤—É—á–∏—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ —Å–ª–æ–≤–æ">üîä</button>
              </div>
            </div>
    
            <!-- –ü–µ—Ä–µ–≤–æ–¥ + RU button (—Å–ø—Ä–∞–≤–∞, –≤–∏–¥–Ω–∞ –≤—Å–µ–≥–¥–∞) -->
            <div class="translation-field" aria-live="polite">
              <p id="translationText" class="translation-text">---</p>
              <button id="speakRU_small" class="tts-btn small" aria-label="–û–∑–≤—É—á–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥">üîä</button>
            </div>
          </div>
        
      </div>

      <button id="nextBtn" class="btn" aria-label="–°–ª–µ–¥—É—é—â–µ–µ —Å–ª–æ–≤–æ">–°–ª–µ–¥—É—é—â–µ–µ —Å–ª–æ–≤–æ</button>
    </div>
  </div>

<script>
/* Telegram WebApp init */
const tg = window.Telegram?.WebApp;
if (tg) tg.ready();

/* Elements */
const usernameEl = document.getElementById('username');
const user = tg?.initDataUnsafe?.user;
if (user) usernameEl.textContent = `–ü—Ä–∏–≤–µ—Ç, ${user.first_name || user.username}!`;

const imageArea = document.getElementById('imageArea');
const imagePlaceholder = document.getElementById('imagePlaceholder');
const wordField = document.getElementById('wordField');
const wordText = document.getElementById('wordText');
const transText = document.getElementById('transText');
const translationText = document.getElementById('translationText');
const speakENBtn = document.getElementById('speakEN_small');
const speakRUBtn = document.getElementById('speakRU_small');
const nextBtn = document.getElementById('nextBtn');

let words = [];
let current = null;
let revealed = false;

/* Utility: set image or placeholder */
function setImage(src) {
  imageArea.innerHTML = '';

  if (!src) {
    // –ü–æ–∫–∞–∑–∞—Ç—å placeholder
    imagePlaceholder.textContent = '–ö–∞—Ä—Ç–∏–Ω–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
    imageArea.appendChild(imagePlaceholder);
    return;
  }

  const img = document.createElement('img');
  img.src = src;
  img.alt = current?.word || 'image';

  img.onerror = () => {
    imageArea.innerHTML = '';
    imagePlaceholder.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
    imageArea.appendChild(imagePlaceholder);
  };

  imageArea.appendChild(img);
}

/* Load words.json (must be UTF-8) */
async function loadWords(){
  try{
    const r = await fetch('words.json', {cache: 'no-store'});
    words = await r.json();
  } catch(e){
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ words.json', e);
    words = [];
  }
}

/* get voice by lang (try to pick best match) */
function getVoice(langPrefix){
  const voices = speechSynthesis.getVoices();
  if (!voices || voices.length === 0) return null;
  // try exact language
  let v = voices.find(x => x.lang && x.lang.toLowerCase().startsWith(langPrefix.toLowerCase()));
  if (v) return v;
  // try english fallback
  v = voices.find(x => x.lang && x.lang.toLowerCase().startsWith('en'));
  if (v) return v;
  return voices[0];
}

/* speak with fallback and safe checks */
function speak(text, langTag){
  if (!text) return;
  if (!('speechSynthesis' in window)){
    console.warn('Speech Synthesis not supported');
    return;
  }
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = langTag;
  const v = getVoice(langTag.split('-')[0]);
  if (v) utter.voice = v;
  speechSynthesis.cancel(); // stop any previous
  speechSynthesis.speak(utter);
}

/* load random word */
function loadRandomWord(){
  if (!words || words.length === 0) {
    translationText.textContent = '---';
    wordText.textContent = '---';
    transText.textContent = '---';
    setImage(null);
    return;
  }

  const idx = Math.floor(Math.random() * words.length);
  current = words[idx];
  revealed = false;

  // fill fields (with safe fallbacks)
  wordText.textContent = current.word || '---';
  transText.textContent = current.transcription ? `[${current.transcription}]` : '---';
  translationText.textContent = current.translation || '---';

  setImage(current.image && current.image.length ? current.image : null);

  // hide english text and EN button
  wordText.classList.remove('visible');
  transText.classList.remove('visible');
  speakENBtn.classList.remove('visible');
}

/* handle reveal on wordField click / Enter */
function revealIfNeeded(){
  if (!revealed){
    wordText.classList.add('visible');
    transText.classList.add('visible');
    // show en button
    speakENBtn.classList.add('visible');
    revealed = true;
  }
}

/* prevent button clicks from propagating to wordField */
speakENBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  if (!current) return;
  // only allow when visible (safety)
  if (!speakENBtn.classList.contains('visible')) return;
  speak(current.word, 'en-US');
});

speakRUBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  if (!current) return;
  speak(current.translation, 'ru-RU');
});

/* allow keyboard access (Enter/Space) to reveal */
wordField.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    revealIfNeeded();
  }
});

/* clicking the field reveals word/transcription */
wordField.addEventListener('click', () => revealIfNeeded());

/* next button */
nextBtn.addEventListener('click', () => {
  // cancel any ongoing speech
  if ('speechSynthesis' in window) speechSynthesis.cancel();
  loadRandomWord();
});

/* init: load voices then words */
(async function init(){
  // ensure voices populated (some browsers load them asynchronously)
  await new Promise(resolve => {
    let done = false;
    function tryVoices(){
      const v = speechSynthesis.getVoices();
      if (v && v.length){
        if (!done){ done = true; resolve(); }
      } else {
        // wait a bit and retry, max ~500ms
        setTimeout(tryVoices, 80);
      }
    }
    tryVoices();
    // also resolve after 700ms even if empty
    setTimeout(() => { if (!done){ done = true; resolve(); } }, 700);
  });

  await loadWords();
  loadRandomWord();
})();
</script>
</body>
</html>


